<div class="reference-editor-container" [class.preview-mode]="previewMode">
  <div class="container">

    <!-- Header -->
    <div class="editor-header">
      <div class="header-left">
        <button class="btn-back" routerLink="/admin">
          ‚Üê Back to Admin
        </button>
        <h1 class="editor-title">
          {{ isEditMode ? 'Edit Reference' : 'Create New Reference' }}
        </h1>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" (click)="togglePreview()">
          {{ previewMode ? '‚úèÔ∏è Edit' : 'üëÅÔ∏è Preview' }}
        </button>
        <button class="btn btn-outline" (click)="saveReference(false)" [disabled]="saving">
          üíæ Save Draft
        </button>
        <button class="btn btn-primary" (click)="saveReference(true)" [disabled]="saving">
          üöÄ Publish
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-overlay">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>

    <!-- PREVIEW MODE -->
    <div *ngIf="previewMode" class="preview-container">
      <div class="preview-header">
        <h2>{{ referenceTitle || 'Untitled Reference' }}</h2>
        <p class="preview-description">{{ referenceDescription }}</p>
      </div>

      <div class="preview-content">
        <div *ngFor="let block of contentBlocks" class="preview-block">

          <!-- Heading Block -->
          <h2 *ngIf="block.blockType === 'heading'" [ngStyle]="{
            'font-family': block.styling?.fontFamily,
            'font-size.px': block.styling?.fontSize,
            'color': block.styling?.color,
            'background-color': block.styling?.backgroundColor,
            'font-weight': block.styling?.fontWeight,
            'text-align': block.styling?.textAlign,
            'line-height': block.styling?.lineHeight,
            'margin-top.px': block.styling?.marginTop,
            'margin-bottom.px': block.styling?.marginBottom,
            'padding.px': block.styling?.padding
          }">
            {{ block.content }}
          </h2>

          <!-- Text Block -->
          <p *ngIf="block.blockType === 'text'" [ngStyle]="{
            'font-family': block.styling?.fontFamily,
            'font-size.px': block.styling?.fontSize,
            'color': block.styling?.color,
            'background-color': block.styling?.backgroundColor,
            'font-weight': block.styling?.fontWeight,
            'font-style': block.styling?.fontStyle,
            'text-decoration': block.styling?.textDecoration,
            'text-align': block.styling?.textAlign,
            'line-height': block.styling?.lineHeight,
            'letter-spacing.px': block.styling?.letterSpacing,
            'margin-top.px': block.styling?.marginTop,
            'margin-bottom.px': block.styling?.marginBottom,
            'padding.px': block.styling?.padding
          }">
            {{ block.content }}
          </p>

          <!-- Image Block -->
          <div *ngIf="block.blockType === 'image'" class="image-block" [ngStyle]="{
            'text-align': block.blockData?.alignment
          }">
            <img [src]="block.blockData?.url"
                 [alt]="block.blockData?.alt"
                 [ngStyle]="{
                   'width': block.blockData?.width,
                   'height': block.blockData?.height,
                   'border-radius.px': block.blockData?.borderRadius
                 }"
                 [class]="'shadow-' + block.blockData?.boxShadow">
          </div>

          <!-- Video Block -->
          <div *ngIf="block.blockType === 'video'" class="video-block" [ngStyle]="{
            'text-align': block.blockData?.alignment
          }">
            <iframe
              *ngIf="block.blockData?.videoId"
              [src]="'https://www.youtube.com/embed/' + block.blockData.videoId | safeUrl"
              [style.width]="block.blockData?.width"
              frameborder="0"
              allowfullscreen>
            </iframe>
          </div>

          <!-- Code Block -->
          <pre *ngIf="block.blockType === 'code_block'" [ngStyle]="{
            'font-family': block.styling?.fontFamily,
            'font-size.px': block.styling?.fontSize,
            'color': block.styling?.color,
            'background-color': block.styling?.backgroundColor,
            'padding.px': block.styling?.padding,
            'margin-top.px': block.styling?.marginTop,
            'margin-bottom.px': block.styling?.marginBottom
          }"><code>{{ block.content }}</code></pre>

        </div>
      </div>
    </div>

    <!-- EDIT MODE -->
    <div *ngIf="!previewMode && !loading" class="edit-container">

      <!-- Basic Information -->
      <div class="basic-info-section">
        <h3>Basic Information</h3>

        <div class="form-row">
          <div class="form-group">
            <label for="major">Major *</label>
            <select
              id="major"
              [(ngModel)]="selectedMajorId"
              (change)="onMajorChange()"
              class="form-control"
              [disabled]="isEditMode">
              <option [ngValue]="null">Select Major</option>
              <option *ngFor="let major of majors" [ngValue]="major.id">
                {{ major.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="topic">Topic *</label>
            <select
              id="topic"
              [(ngModel)]="selectedTopicId"
              class="form-control"
              [disabled]="!selectedMajorId || isEditMode">
              <option [ngValue]="null">Select Topic</option>
              <option *ngFor="let topic of topics" [ngValue]="topic.id">
                {{ topic.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="title">Title *</label>
          <input
            type="text"
            id="title"
            [(ngModel)]="referenceTitle"
            class="form-control"
            placeholder="e.g., Complete HTML5 Guide">
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            [(ngModel)]="referenceDescription"
            class="form-control"
            rows="3"
            placeholder="Short description of this reference"></textarea>
        </div>
      </div>

      <!-- Content Blocks Section -->
      <div class="content-blocks-section">
        <h3>Content Blocks</h3>

        <div class="blocks-layout">

          <!-- Left Panel: Block List -->
          <div class="blocks-list-panel">
            <div class="panel-header">
              <h4>Content Blocks ({{ contentBlocks.length }})</h4>
            </div>

            <div class="blocks-list" cdkDropList (cdkDropListDropped)="drop($event)">
              <div *ngFor="let block of contentBlocks; let i = index"
                   class="block-item"
                   cdkDrag>
                <div class="block-handle" cdkDragHandle>‚ò∞</div>
                <div class="block-info">
                  <span class="block-icon">{{ getBlockTypeIcon(block.blockType) }}</span>
                  <div class="block-details">
                    <strong class="block-number">#{{ i + 1 }}</strong>
                    <span class="block-preview">{{ getBlockPreview(block) }}</span>
                  </div>
                </div>
                <div class="block-actions">
                  <button class="btn-icon" (click)="editBlock(i)" title="Edit">‚úèÔ∏è</button>
                  <button class="btn-icon btn-delete" (click)="deleteBlock(i)" title="Delete">üóëÔ∏è</button>
                </div>
              </div>
            </div>

            <div *ngIf="contentBlocks.length === 0" class="empty-blocks">
              <p>No content blocks yet</p>
              <p class="hint">Add blocks using buttons on the right ‚Üí</p>
            </div>
          </div>

          <!-- Center Panel: Block Editor -->
          <div class="block-editor-panel" *ngIf="showBlockEditor && currentBlock">
            <div class="panel-header">
              <h4>{{ editingBlockIndex !== null ? 'Edit' : 'Add' }} {{ currentBlock.blockType | titlecase }} Block</h4>
              <button class="btn-close" (click)="closeBlockEditor()">‚úï</button>
            </div>

            <div class="editor-content">

              <!-- TEXT/HEADING BLOCK EDITOR -->
              <div *ngIf="currentBlock.blockType === 'text' || currentBlock.blockType === 'heading'" class="text-editor">

                <div class="form-group">
                  <label>Topic Name (Optional)</label>
                  <input type="text"
                         [(ngModel)]="currentBlock.topicName"
                         class="form-control"
                         placeholder="e.g., Introduction to HTML">
                </div>

                <div class="form-group">
                  <label>Content *</label>
                  <textarea
                    [(ngModel)]="currentBlock.content"
                    class="form-control content-textarea"
                    rows="6"
                    placeholder="Enter your text here..."></textarea>
                </div>

                <!-- Styling Toolbar -->
                <div class="styling-toolbar">
                  <h5>Text Styling</h5>

                  <div class="toolbar-row">
                    <div class="toolbar-group">
                      <label>Font</label>
                      <select [(ngModel)]="currentBlock.styling!.fontFamily" class="form-control-sm">
                        <option>Arial</option>
                        <option>Times New Roman</option>
                        <option>Helvetica</option>
                        <option>Georgia</option>
                        <option>Courier New</option>
                        <option>Verdana</option>
                      </select>
                    </div>

                    <div class="toolbar-group">
                      <label>Size</label>
                      <input type="number"
                             [(ngModel)]="currentBlock.styling!.fontSize"
                             class="form-control-sm"
                             min="10"
                             max="72">
                    </div>

                    <div class="toolbar-group">
                      <label>Color</label>
                      <input type="color"
                             [(ngModel)]="currentBlock.styling!.color"
                             class="color-picker">
                    </div>

                    <div class="toolbar-group">
                      <label>Background</label>
                      <input type="color"
                             [(ngModel)]="currentBlock.styling!.backgroundColor"
                             class="color-picker">
                    </div>
                  </div>

                  <div class="toolbar-row">
                    <div class="toolbar-group">
                      <label>Weight</label>
                      <select [(ngModel)]="currentBlock.styling!.fontWeight" class="form-control-sm">
                        <option value="normal">Normal</option>
                        <option value="bold">Bold</option>
                        <option value="300">Light</option>
                        <option value="600">Semi-bold</option>
                        <option value="900">Black</option>
                      </select>
                    </div>

                    <div class="toolbar-group">
                      <label>Align</label>
                      <select [(ngModel)]="currentBlock.styling!.textAlign" class="form-control-sm">
                        <option value="left">Left</option>
                        <option value="center">Center</option>
                        <option value="right">Right</option>
                        <option value="justify">Justify</option>
                      </select>
                    </div>

                    <div class="toolbar-group">
                      <label>Line Height</label>
                      <input type="number"
                             [(ngModel)]="currentBlock.styling!.lineHeight"
                             class="form-control-sm"
                             min="1"
                             max="3"
                             step="0.1">
                    </div>

                    <div class="toolbar-group">
                      <label>Spacing</label>
                      <input type="number"
                             [(ngModel)]="currentBlock.styling!.letterSpacing"
                             class="form-control-sm"
                             min="0"
                             max="10">
                    </div>
                  </div>

                  <div class="toolbar-row">
                    <div class="toolbar-group">
                      <label>Margin Top</label>
                      <input type="number"
                             [(ngModel)]="currentBlock.styling!.marginTop"
                             class="form-control-sm"
                             min="0"
                             max="100">
                    </div>

                    <div class="toolbar-group">
                      <label>Margin Bottom</label>
                      <input type="number"
                             [(ngModel)]="currentBlock.styling!.marginBottom"
                             class="form-control-sm"
                             min="0"
                             max="100">
                    </div>

                    <div class="toolbar-group">
                      <label>Padding</label>
                      <input type="number"
                             [(ngModel)]="currentBlock.styling!.padding"
                             class="form-control-sm"
                             min="0"
                             max="100">
                    </div>
                  </div>
                </div>

                <!-- Live Preview -->
                <div class="live-preview">
                  <h5>Live Preview:</h5>
                  <div class="preview-box" [ngStyle]="{
                    'font-family': currentBlock.styling?.fontFamily,
                    'font-size.px': currentBlock.styling?.fontSize,
                    'color': currentBlock.styling?.color,
                    'background-color': currentBlock.styling?.backgroundColor,
                    'font-weight': currentBlock.styling?.fontWeight,
                    'text-align': currentBlock.styling?.textAlign,
                    'line-height': currentBlock.styling?.lineHeight,
                    'letter-spacing.px': currentBlock.styling?.letterSpacing,
                    'padding.px': currentBlock.styling?.padding
                  }">
                    {{ currentBlock.content || 'Your text will appear here...' }}
                  </div>
                </div>
              </div>

              <!-- IMAGE BLOCK EDITOR -->
              <div *ngIf="currentBlock.blockType === 'image'" class="image-editor">

                <div class="form-group">
                  <label>Upload Image *</label>
                  <input type="file"
                         (change)="onImageSelect($event)"
                         accept="image/jpeg,image/png"
                         class="form-control">
                  <small>JPG or PNG, max 2MB</small>
                </div>

                <div *ngIf="currentBlock.blockData?.url" class="image-preview">
                  <img [src]="currentBlock.blockData.url" alt="Preview">
                </div>

                <div class="form-group">
                  <label>Alt Text</label>
                  <input type="text"
                         [(ngModel)]="currentBlock.blockData!.alt"
                         class="form-control"
                         placeholder="Describe the image">
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Width</label>
                    <input type="text"
                           [(ngModel)]="currentBlock.blockData!.width"
                           class="form-control"
                           placeholder="100% or 500px">
                  </div>

                  <div class="form-group">
                    <label>Alignment</label>
                    <select [(ngModel)]="currentBlock.blockData!.alignment" class="form-control">
                      <option value="left">Left</option>
                      <option value="center">Center</option>
                      <option value="right">Right</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Border Radius (px)</label>
                    <input type="number"
                           [(ngModel)]="currentBlock.blockData!.borderRadius"
                           class="form-control"
                           min="0"
                           max="50">
                  </div>

                  <div class="form-group">
                    <label>Shadow</label>
                    <select [(ngModel)]="currentBlock.blockData!.boxShadow" class="form-control">
                      <option value="none">None</option>
                      <option value="light">Light</option>
                      <option value="medium">Medium</option>
                      <option value="dark">Dark</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- VIDEO BLOCK EDITOR -->
              <div *ngIf="currentBlock.blockType === 'video'" class="video-editor">

                <div class="form-group">
                  <label>YouTube URL *</label>
                  <input type="text"
                         [ngModel]="currentBlock.blockData?.url"
                         (ngModelChange)="onVideoUrlChange($event)"
                         class="form-control"
                         placeholder="https://www.youtube.com/watch?v=...">
                  <small>Paste a YouTube video link</small>
                </div>

                <div *ngIf="currentBlock.blockData?.videoId" class="video-preview">
                  <iframe
                    [src]="'https://www.youtube.com/embed/' + currentBlock.blockData.videoId"
                    width="100%"
                    height="300"
                    frameborder="0"
                    allowfullscreen>
                  </iframe>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Width</label>
                    <select [(ngModel)]="currentBlock.blockData!.width" class="form-control">
                      <option value="100%">100%</option>
                      <option value="80%">80%</option>
                      <option value="60%">60%</option>
                      <option value="50%">50%</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Alignment</label>
                    <select [(ngModel)]="currentBlock.blockData!.alignment" class="form-control">
                      <option value="left">Left</option>
                      <option value="center">Center</option>
                      <option value="right">Right</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- CODE BLOCK EDITOR -->
              <div *ngIf="currentBlock.blockType === 'code_block'" class="code-editor">

                <div class="form-group">
                  <label>Language</label>
                  <select [(ngModel)]="currentBlock.blockData!.language" class="form-control">
                    <option value="javascript">JavaScript</option>
                    <option value="python">Python</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="java">Java</option>
                    <option value="typescript">TypeScript</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Code *</label>
                  <textarea
                    [(ngModel)]="currentBlock.content"
                    class="form-control code-textarea"
                    rows="10"
                    placeholder="Paste your code here..."></textarea>
                </div>

                <!-- Code Preview -->
                <div class="code-preview">
                  <pre [ngStyle]="{
                    'background-color': currentBlock.styling?.backgroundColor,
                    'color': currentBlock.styling?.color,
                    'padding.px': currentBlock.styling?.padding
                  }"><code>{{ currentBlock.content }}</code></pre>
                </div>
              </div>

            </div>

            <div class="editor-footer">
              <button class="btn btn-outline" (click)="closeBlockEditor()">Cancel</button>
              <button class="btn btn-primary" (click)="saveCurrentBlock()">
                {{ editingBlockIndex !== null ? 'Update Block' : 'Add Block' }}
              </button>
            </div>
          </div>

          <!-- Right Panel: Add Block Buttons -->
          <div class="add-blocks-panel" *ngIf="!showBlockEditor">
            <div class="panel-header">
              <h4>Add Content</h4>
            </div>

            <div class="add-buttons">
              <button class="add-btn" (click)="addHeadingBlock()">
                <span class="btn-icon">üìå</span>
                <span class="btn-text">Add Heading</span>
              </button>

              <button class="add-btn" (click)="addTextBlock()">
                <span class="btn-icon">üìù</span>
                <span class="btn-text">Add Text</span>
              </button>

              <button class="add-btn" (click)="addImageBlock()">
                <span class="btn-icon">üñºÔ∏è</span>
                <span class="btn-text">Add Image</span>
              </button>

              <button class="add-btn" (click)="addVideoBlock()">
                <span class="btn-icon">‚ñ∂Ô∏è</span>
                <span class="btn-text">Add Video</span>
              </button>

              <button class="add-btn" (click)="addCodeBlock()">
                <span class="btn-icon">&#123; &#125;</span>
                <span class="btn-text">Add Code</span>
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>

  </div>
</div>
