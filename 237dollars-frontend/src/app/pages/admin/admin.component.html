<div class="admin-container">
  <div class="container">
    <!-- Header -->
    <div class="admin-header">
      <div class="header-content">
        <h1 class="admin-title">
          <span class="icon">ğŸ›¡ï¸</span>
          Admin Dashboard
        </h1>
        <p class="admin-subtitle">Manage references and content</p>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="admin-tabs">
      <button
        class="tab-button"
        [class.active]="activeTab === 'references'"
        (click)="switchTab('references')"
      >
        <span class="tab-icon">ğŸ“š</span>
        References
      </button>
      <button
        class="tab-button"
        [class.active]="activeTab === 'blog'"
        (click)="switchTab('blog')"
      >
        <span class="tab-icon">ğŸ–¼ï¸</span>
        Blog Galleries
      </button>
      <button
        *ngIf="isSuperAdmin()"
        class="tab-button"
        [class.active]="activeTab === 'admins'"
        (click)="switchTab('admins')"
      >
        <span class="tab-icon">ğŸ‘¥</span>
        Admin Management
      </button>
    </div>

    <!-- Tab Content: References -->
    <div class="tab-content" *ngIf="activeTab === 'references'">
      <div class="header-actions">
        <button class="btn btn-primary" routerLink="/admin/references/new">
          <span class="icon">â•</span>
          Create Reference
        </button>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <div class="filters-row">
          <div class="filter-group">
            <label for="publishedFilter">Status:</label>
            <select
              id="publishedFilter"
              [(ngModel)]="publishedFilter"
              (change)="onFilterChange()"
              class="filter-select"
            >
              <option value="all">All References</option>
              <option value="published">Published Only</option>
              <option value="unpublished">Unpublished Only</option>
            </select>
          </div>

          <div class="filter-group">
            <label for="majorFilter">Major:</label>
            <select
              id="majorFilter"
              [(ngModel)]="majorFilter"
              (change)="onMajorFilterChange()"
              class="filter-select"
            >
              <option [ngValue]="'all'">All Majors</option>
              <option *ngFor="let major of majors" [ngValue]="major.id">
                {{ major.name }}
              </option>
            </select>
          </div>

          <div class="filter-group">
            <label for="topicFilter">Topic:</label>
            <select
              id="topicFilter"
              [(ngModel)]="topicFilter"
              (change)="onFilterChange()"
              class="filter-select"
              [disabled]="majorFilter !== 'all' && filteredTopics.length === 0"
            >
              <option [ngValue]="'all'">All Topics</option>
              <option *ngFor="let topic of filteredTopics" [ngValue]="topic.id">
                {{ topic.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="stats">
          <span class="stat-item">
            <strong>Total:</strong> {{ totalReferences }}
          </span>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner"></div>
        <p>Loading references...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="error-state">
        <div class="error-icon">âš ï¸</div>
        <h3>Error Loading References</h3>
        <p>{{ error }}</p>
        <button class="btn btn-outline" (click)="loadReferences()">Try Again</button>
      </div>

      <!-- References Table -->
      <div *ngIf="!loading && !error" class="references-table">
        <div *ngIf="references.length === 0" class="empty-state">
          <div class="empty-icon">ğŸ“„</div>
          <h3>No References Found</h3>
          <p>Start by creating your first reference</p>
          <button class="btn btn-primary" routerLink="/admin/references/new">
            Create Reference
          </button>
        </div>

        <table *ngIf="references.length > 0">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Major</th>
              <th>Topic</th>
              <th>Status</th>
              <th>Created</th>
              <th>Creator</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let reference of references; let i = index"
              [class.unpublished]="!reference.isPublished"
              [class.dragging]="i === draggedReferenceIndex"
              [class.drag-over]="i === dragOverReferenceIndex"
              draggable="true"
              (dragstart)="onReferenceDragStart($event, i)"
              (dragover)="onReferenceDragOver($event, i)"
              (dragleave)="onReferenceDragLeave($event)"
              (drop)="onReferenceDrop($event, i)"
              (dragend)="onReferenceDragEnd()"
            >
              <td class="id-cell">{{ reference.id }}</td>
              <td class="title-cell">
                <div class="title-content">
                  <strong>{{ reference.title }}</strong>
                  <p *ngIf="reference.description" class="description">
                    {{ reference.description }}
                  </p>
                </div>
              </td>
              <td class="major-cell">
                {{ reference.topic?.major?.name || 'N/A' }}
              </td>
              <td class="topic-cell">
                {{ reference.topic?.name || 'N/A' }}
              </td>
              <td class="status-cell">
                <span class="status-badge" [class.published]="reference.isPublished">
                  {{ reference.isPublished ? 'âœ“ Published' : 'â—‹ Draft' }}
                </span>
              </td>
              <td class="date-cell">
                {{ formatDate(reference.createdAt) }}
              </td>
              <td class="creator-cell">
                {{ reference.creator?.email || 'Unknown' }}
              </td>
              <td class="actions-cell">
                <div class="action-buttons">
                  <button
                    class="btn-icon btn-view"
                    [routerLink]="['/references', reference.id]"
                    title="View"
                  >
                    ğŸ‘ï¸
                  </button>
                  <button
                    class="btn-icon btn-edit"
                    [routerLink]="['/admin/references', reference.id, 'edit']"
                    title="Edit"
                  >
                    âœï¸
                  </button>
                  <button
                    class="btn-icon btn-toggle"
                    (click)="togglePublish(reference)"
                    [title]="reference.isPublished ? 'Unpublish' : 'Publish'"
                  >
                    {{ reference.isPublished ? 'ğŸ”½' : 'ğŸ”¼' }}
                  </button>
                  <button
                    class="btn-icon btn-delete"
                    (click)="deleteReference(reference)"
                    title="Delete"
                  >
                    ğŸ—‘ï¸
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div *ngIf="!loading && totalPages > 1" class="pagination">
        <button
          class="pagination-btn"
          (click)="goToPage(currentPage - 1)"
          [disabled]="currentPage === 1"
        >
          â† Previous
        </button>

        <div class="page-numbers">
          <button
            *ngFor="let page of getPageNumbers()"
            class="page-btn"
            [class.active]="page === currentPage"
            (click)="goToPage(page)"
          >
            {{ page }}
          </button>
        </div>

        <button
          class="pagination-btn"
          (click)="goToPage(currentPage + 1)"
          [disabled]="currentPage === totalPages"
        >
          Next â†’
        </button>
      </div>
    </div>

    <!-- Tab Content: Blog Galleries -->
    <div class="tab-content" *ngIf="activeTab === 'blog'">
      <div class="header-actions">
        <button class="btn btn-primary" routerLink="/admin/galleries/new">
          <span class="icon">â•</span>
          Create New Gallery
        </button>
      </div>

      <!-- Galleries Grid -->
      <div class="galleries-grid">
        <div
          class="gallery-card"
          *ngFor="let gallery of galleries; let i = index"
          [class.dragging]="i === draggedGalleryIndex"
          [class.drag-over]="i === dragOverGalleryIndex"
          draggable="true"
          (dragstart)="onGalleryDragStart($event, i)"
          (dragover)="onGalleryDragOver($event, i)"
          (dragleave)="onGalleryDragLeave($event)"
          (drop)="onGalleryDrop($event, i)"
          (dragend)="onGalleryDragEnd()"
        >
          <div class="gallery-thumbnail">
            <img [src]="getMainGalleryImage(gallery)" [alt]="gallery.title" />
            <span class="image-count" *ngIf="getGalleryImageCount(gallery) > 1">
              {{ getGalleryImageCount(gallery) }} images
            </span>
          </div>
          <div class="gallery-info">
            <h3>{{ gallery.title || 'Untitled' }}</h3>
            <p class="description">{{ gallery.description | slice: 0:100 }}{{ gallery.description.length > 100 ? '...' : '' }}</p>
            <span class="status-badge" [ngClass]="gallery.isPublished ? 'published' : 'draft'">
              {{ gallery.isPublished ? 'Published' : 'Draft' }}
            </span>
          </div>
          <div class="gallery-actions">
            <button
              class="btn-icon"
              [routerLink]="['/admin/galleries', gallery.id, 'edit']"
              title="Edit"
            >
              âœï¸
            </button>
            <button
              class="btn-icon btn-danger"
              (click)="deleteGallery(gallery.id)"
              [disabled]="false"
              title="Delete"
            >
              ğŸ—‘ï¸
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="galleries.length === 0">
          <div class="empty-icon">ğŸ–¼ï¸</div>
          <h3>No galleries yet</h3>
          <p>Create your first gallery to get started</p>
          <button class="btn btn-primary" routerLink="/admin/galleries/new">
            Create Gallery
          </button>
        </div>
      </div>
    </div>

    <!-- Tab Content: Admin Management -->
    <div class="tab-content" *ngIf="activeTab === 'admins' && isSuperAdmin()">
      <!-- Admin Statistics -->
      <div class="stats-grid" *ngIf="adminStats">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-content">
            <div class="stat-value">{{ adminStats.totalAdmins }}</div>
            <div class="stat-label">Total Admins</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-content">
            <div class="stat-value">{{ adminStats.activeAdmins }}</div>
            <div class="stat-label">Active Admins</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">â¸ï¸</div>
          <div class="stat-content">
            <div class="stat-value">{{ adminStats.inactiveAdmins }}</div>
            <div class="stat-label">Inactive Admins</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-content">
            <div class="stat-value">{{ adminStats.studentManagers }}</div>
            <div class="stat-label">Student Managers</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-content">
            <div class="stat-value">{{ adminStats.contentManagers }}</div>
            <div class="stat-label">Content Managers</div>
          </div>
        </div>
      </div>

      <!-- Create Admin Button -->
      <div class="header-actions">
        <button class="btn btn-primary" (click)="showCreateAdminForm = !showCreateAdminForm">
          <span class="icon">{{ showCreateAdminForm ? 'âœ–ï¸' : 'â•' }}</span>
          {{ showCreateAdminForm ? 'Cancel' : 'Create New Admin' }}
        </button>
      </div>

      <!-- Create Admin Form -->
      <div class="create-admin-form" *ngIf="showCreateAdminForm && !showEditAdminForm">
        <h3>Create New Admin</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="adminEmail">Email *</label>
            <input
              id="adminEmail"
              type="email"
              [(ngModel)]="newAdmin.email"
              placeholder="admin@example.com"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label for="adminPassword">Password *</label>
            <input
              id="adminPassword"
              type="password"
              [(ngModel)]="newAdmin.password"
              placeholder="At least 8 characters"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label for="adminRole">Role *</label>
            <select id="adminRole" [(ngModel)]="newAdmin.role" class="form-control">
              <option *ngFor="let role of adminRoles" [value]="role.value">
                {{ role.label }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="adminTelegram">Telegram Username</label>
            <input
              id="adminTelegram"
              type="text"
              [(ngModel)]="newAdmin.telegramUsername"
              placeholder="@username or username"
              class="form-control"
            />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" (click)="createAdmin()">
            Create Admin
          </button>
          <button class="btn btn-outline" (click)="showCreateAdminForm = false">
            Cancel
          </button>
        </div>
      </div>

      <!-- Edit Admin Form -->
      <div class="create-admin-form" *ngIf="showEditAdminForm">
        <h3>Edit Admin</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="editAdminEmail">Email</label>
            <input
              id="editAdminEmail"
              type="email"
              [(ngModel)]="editAdmin.email"
              placeholder="admin@example.com"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label for="editAdminPassword">Password (leave empty to keep current)</label>
            <input
              id="editAdminPassword"
              type="password"
              [(ngModel)]="editAdmin.password"
              placeholder="Enter new password to change"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label for="editAdminRole">Role</label>
            <select id="editAdminRole" [(ngModel)]="editAdmin.role" class="form-control">
              <option *ngFor="let role of adminRoles" [value]="role.value">
                {{ role.label }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="editAdminTelegram">Telegram Username</label>
            <input
              id="editAdminTelegram"
              type="text"
              [(ngModel)]="editAdmin.telegramUsername"
              placeholder="@username or username"
              class="form-control"
            />
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" (click)="saveEditAdmin()">
            Save Changes
          </button>
          <button class="btn btn-outline" (click)="cancelEdit()">
            Cancel
          </button>
        </div>
      </div>

      <!-- Admins List -->
      <div class="admins-section">
        <h3>All Admins</h3>
        <div class="admins-table">
          <table *ngIf="admins.length > 0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Username</th>
                <th>Role</th>
                <th>Telegram</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let admin of admins" [class.inactive]="!admin.isActive">
                <td>{{ admin.id }}</td>
                <td>{{ admin.email }}</td>
                <td>{{ admin.username || 'N/A' }}</td>
                <td>
                  <select
                    *ngIf="admin.role !== 'super_admin' && currentUser?.id !== admin.id"
                    [(ngModel)]="admin.role"
                    (change)="updateAdminRole(admin, admin.role)"
                    class="role-select"
                  >
                    <option *ngFor="let role of adminRoles" [value]="role.value">
                      {{ role.label }}
                    </option>
                  </select>
                  <span *ngIf="admin.role === 'super_admin' || currentUser?.id === admin.id" class="role-badge super-admin">
                    {{ formatRole(admin.role) }}
                  </span>
                </td>
                <td>
                  <span class="telegram-username">{{ admin.telegramUsername ? '@' + admin.telegramUsername : 'N/A' }}</span>
                </td>
                <td>
                  <span class="status-badge" [class.active]="admin.isActive">
                    {{ admin.isActive ? 'âœ“ Active' : 'â—‹ Inactive' }}
                  </span>
                </td>
                <td>{{ admin.lastLogin ? formatDate(admin.lastLogin) : 'Never' }}</td>
                <td class="actions-cell">
                  <div class="action-buttons">
                    <button
                      class="btn-icon btn-edit"
                      (click)="openEditAdmin(admin)"
                      title="Edit Admin"
                    >
                      âœï¸
                    </button>
                    <button
                      *ngIf="admin.isActive && admin.role !== 'super_admin' && currentUser?.id !== admin.id"
                      class="btn-icon btn-warning"
                      (click)="deactivateAdmin(admin)"
                      title="Deactivate"
                    >
                      â¸ï¸
                    </button>
                    <button
                      *ngIf="!admin.isActive"
                      class="btn-icon btn-success"
                      (click)="reactivateAdmin(admin)"
                      title="Reactivate"
                    >
                      â–¶ï¸
                    </button>
                    <span *ngIf="currentUser?.id === admin.id" class="you-badge">
                      (You)
                    </span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="empty-state" *ngIf="admins.length === 0">
            <div class="empty-icon">ğŸ‘¥</div>
            <h3>No Admins Found</h3>
            <p>Create your first admin to get started</p>
          </div>
        </div>
      </div>

      <!-- Activity Logs -->
      <div class="activity-logs-section">
        <h3>Recent Activity</h3>
        <div class="activity-logs">
          <div class="activity-item" *ngFor="let log of activityLogs">
            <div class="activity-icon">ğŸ“</div>
            <div class="activity-content">
              <div class="activity-description">{{ log.description }}</div>
              <div class="activity-meta">
                <span class="activity-admin">{{ log.admin.email }}</span>
                <span class="activity-separator">â€¢</span>
                <span class="activity-date">{{ formatDate(log.createdAt) }}</span>
              </div>
            </div>
          </div>

          <div class="empty-state" *ngIf="activityLogs.length === 0">
            <div class="empty-icon">ğŸ“‹</div>
            <p>No recent activity</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
